{% extends 'base.html' %}
{% block content %}
{% if just_activated %}
<div id="subscriptionPopupOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div id="subscriptionPopupContent" class="card w-full max-w-lg p-6 sm:p-8 relative text-center animate-fade-in">

        <button onclick="closeSubscriptionPopup()" class="absolute top-4 right-4 text-slate-400 text-2xl hover:text-slate-600 transition-colors">&times;</button>

        <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-gradient-to-br from-green-400 to-blue-500 mb-5 shadow-lg">
            <span class="text-4xl text-white">üéâ</span>
        </div>

        <h2 class="text-2xl font-bold text-slate-900">–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!</h2>
        <p class="text-slate-600 mt-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π! –¢–µ–ø–µ—Ä—å –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–∫–ª—é—á–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∏–µ—Ç –∏ –≥–ª—É–±–æ–∫—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É.</p>

        <div class="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
    <button onclick="closeSubscriptionPopup()" class="btn btn-primary">
        üöÄ –ù–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
    </button>
    <a href="{{ url_for('welcome_guide') }}" class="btn btn-secondary">
        ü§î –ß—Ç–æ —è –ø–æ–ª—É—á–∏–ª?
    </a>
</div>
    </div>
</div>

<script>
    const popupOverlay = document.getElementById('subscriptionPopupOverlay');

   function closeSubscriptionPopup() {
    if (popupOverlay) {
        // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –æ–Ω "–∑–∞–ø–æ–º–Ω–∏–ª", —á—Ç–æ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ
        fetch('/api/dismiss_welcome_popup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).catch(err => console.error("Failed to dismiss popup on server:", err));

        // 2. –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
        popupOverlay.style.transition = 'opacity 0.3s ease';
        popupOverlay.style.opacity = '0';
        setTimeout(() => {
popupOverlay.style.display = 'none';
lockScroll(false);
        }, 300);
    }
}

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    if (popupOverlay) {
        popupOverlay.addEventListener('click', function(event) {
            if (event.target === popupOverlay) {
                closeSubscriptionPopup();
            }
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –Ω–∞ –∫–ª–∞–≤–∏—à—É Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeSubscriptionPopup();
        }
    });
</script>
{% endif %}
<style>
    /* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    .locked-feature {
        position: relative;
        opacity: 0.6;
        filter: grayscale(80%);
        pointer-events: none; /* –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ –ø–æ –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º */
    }
    .locked-overlay {
        position: absolute;
        inset: 0;
        background: rgba(241, 245, 249, 0.7); /* slate-100 —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
        border-radius: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 1rem;
        z-index: 10;
        pointer-events: auto; /* –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∏–∫–∏ –¥–ª—è –æ–≤–µ—Ä–ª–µ—è */
    }
    .locked-text {
        font-weight: 600;
        color: #1e293b; /* slate-800 */
    }
    .locked-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .flip-card-back {
  position: relative;
}
.flip-card-back::after{
  content:"";
  position:absolute; left:0; right:0; bottom:0; height:28px;
  pointer-events:none;
  background: linear-gradient(to bottom, rgba(243,244,246,0), rgba(243,244,246,1));
}


    .progress-bar-animate { transition: width 0.5s ease-out; }

  /* –û–±—â–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ */
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: scale(0.9);}
    to {opacity: 1; transform: scale(1);}
  }

  @media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; }
}


  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–≥–æ —Ñ–æ–Ω–∞ */
  @keyframes pulse-background {
    0% { opacity: 0; }
    50% { opacity: 0.2; }
    100% { opacity: 0; }
  }
  .animate-pulse-background:hover {
    animation: pulse-background 1.5s infinite;
  }

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
  .btn-hover-animate {
    transition: all 0.3s ease;
    transform: translateY(0);
  }
  .btn-hover-animate:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
  .card-hover-animate {
    transition: all 0.3s ease;
  }
  .card-hover-animate:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
  .icon-hover-animate {
    transition: transform 0.3s ease;
  }
  .icon-hover-animate:hover {
    transform: scale(1.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
  .tab-hover-animate {
    transition: all 0.2s ease;
  }
  .tab-hover-animate:hover {
    background-color: rgba(59, 130, 246, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã */
  .form-input-hover {
    transition: all 0.2s ease;
  }
  .form-input-hover:hover {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ */
  .list-item-hover {
    transition: all 0.2s ease;
  }
  .list-item-hover:hover {
    background-color: rgba(243, 244, 246, 0.5);
    transform: translateX(2px);
  }

  /* –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –≥—Ä—É–ø–ø—ã */
  .group-card-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .group-card-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Ü–µ–ª–µ–π/–ø–æ–ª–∞ */
  .selection-card {
    transition: all 0.3s ease;
  }
  .selection-card:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
</style>
<style>
  :root {
    --brand-primary: #3b82f6; /* blue-500 */
    --brand-secondary: #6366f1; /* indigo-500 */
    --surface-ground: #f8fafc; /* slate-50 */
    --surface-card: #ffffff;
    --text-primary: #1e293b; /* slate-800 */
    --text-secondary: #64748b; /* slate-500 */
    --border-soft: #e2e8f0; /* slate-200 */
  }

  /* --- Base & Layout --- */
  body {
    background-color: var(--surface-ground);
    color: var(--text-primary);
  }

  .page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1.5rem 1rem;
  }

  /* --- Animations --- */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  /* --- Card Component --- */
  .card {
    background-color: var(--surface-card);
    border-radius: 1rem; /* 16px */
    border: 1px solid var(--border-soft);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
    transition: all 0.3s ease-in-out;
  }
  .card:hover {
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
    transform: translateY(-2px);
  }

  /* --- Navigation Tabs --- */
  .nav-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    border-bottom: 1px solid var(--border-soft);
    margin-bottom: 2rem;
  }
  .nav-tab {
    padding: 0.75rem 1rem;
    font-weight: 500;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }
  .nav-tab:hover {
    color: var(--brand-primary);
  }
  .nav-tab.active {
    color: var(--brand-primary);
    border-bottom-color: var(--brand-primary);
  }

  /* --- Buttons --- */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }
  .btn-primary {
    background-color: var(--brand-primary);
    color: white;
  }
  .btn-primary:hover {
    background-color: #2563eb; /* blue-600 */
  }
  .btn-secondary {
    background-color: var(--surface-ground);
    color: var(--text-primary);
    border-color: var(--border-soft);
  }
  .btn-secondary:hover {
    background-color: #f1f5f9; /* slate-100 */
    border-color: #cbd5e1; /* slate-300 */
  }

  /* --- Forms --- */
  .form-input {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--border-soft);
    border-radius: 0.5rem;
    background-color: #f8fafc;
    transition: all 0.2s ease;
  }
  .form-input:focus {
    outline: none;
    border-color: var(--brand-primary);
    background-color: white;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }
  .selection-card {
    padding: 1rem;
    border: 2px solid var(--border-soft);
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .selection-card:hover {
    border-color: var(--brand-secondary);
    background-color: #f0fdfa; /* light teal for hover */
  }
  .selection-card.selected {
    border-color: var(--brand-primary);
    background-color: #eff6ff; /* light blue */
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }

  /* --- Progress Bar --- */
  .progress-bar-bg {
    background-color: #e5e7eb; /* gray-200 */
    border-radius: 9999px;
    height: 0.75rem;
    overflow: hidden;
  }
  .progress-bar-fill {
    background-image: linear-gradient(to right, #fb923c, #f97316); /* orange-400 to orange-500 */
    height: 100%;
    border-radius: 9999px;
    transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
  }

  .flip-card {
  background-color: transparent;
  width: 100%;
  height: 280px; /* –ó–∞–¥–∞–π—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É */
  perspective: 1000px;
}
.flip-card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  text-align: center;
  transition: transform 0.6s;
  transform-style: preserve-3d;
}
/* –ö–ª–∞—Å—Å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ñ–ª–∏–ø–∞ */
.flip-card.is-flipped .flip-card-inner {
  transform: rotateY(180deg);
}
.flip-card-front, .flip-card-back {
  position: absolute;
  width: 100%;
  height: 100%;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  display: flex;
  flex-direction: column;
  border-radius: 1rem; /* 16px */
  border: 1px solid var(--border-soft);
  overflow: hidden;
}
.flip-card-front {
  background-color: var(--surface-card);
}
.flip-card-back {
  background-color: #f3f4f6; /* gray-100 */
  color: var(--text-primary);
  transform: rotateY(180deg);
  padding: 1.5rem;
  justify-content: flex-start; /* 1. –ü—Ä–∏–∂–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∫ –≤–µ—Ä—Ö—É */
  overflow-y: auto;          /* 2. –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
}

/* 3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–µ–ª–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –∫—Ä–∞—Å–∏–≤–µ–µ */
.flip-card-back::-webkit-scrollbar {
  width: 6px;
}
.flip-card-back::-webkit-scrollbar-track {
  background: transparent;
}
.flip-card-back::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
  border: 3px solid transparent;
}
</style>
<div class="max-w-7xl mx-auto px-4 py-6">

<div id="infoBanner" class="relative bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl p-6 mb-6 shadow-lg">
<button onclick="hideBanner()" aria-label="–°–∫—Ä—ã—Ç—å –±–∞–Ω–Ω–µ—Ä" class="absolute top-3 right-4 text-white/70 hover:text-white text-2xl font-bold">&times;</button>

    <div class="flex items-center">
        <div class="hidden sm:block mr-5 text-4xl opacity-80">‚åöÔ∏è</div>
        <div>
            <h3 class="font-bold text-xl">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º—É Kilogr.app!</h3>
            <p class="mt-1 text-white/90">–ü–æ–ª—É—á–∏–ª–∏ —Å–≤–æ–∏ —É–º–Ω—ã–µ –≤–µ—Å—ã –∏ —á–∞—Å—ã? –û–Ω–∏ –ø–æ–º–æ–≥—É—Ç –≤–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –¥–æ—Å—Ç–∏–≥–∞—Ç—å —Ü–µ–ª–µ–π –µ—â–µ –±—ã—Å—Ç—Ä–µ–µ.</p>
            <a href="#" class="inline-block mt-3 text-sm font-semibold bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –Ω–∞—à–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</a>
        </div>
    </div>
</div>

<div id="restoreBannerContainer" class="text-center mb-6" style="display: none;">
<button onclick="showBanner()" aria-controls="infoBanner"
        class="text-sm text-blue-600 hover:underline font-semibold">
  –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
</button>
</div>
    <div class="flex flex-wrap gap-2 border-b mb-6 overflow-x-auto scrollbar-hide px-1">
    <a href="/profile"
       class="px-4 py-2 font-medium {% if request.path == '/profile' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
      –ü—Ä–æ—Ñ–∏–ª—å
    </a>
    <a href="/metrics"
       class="px-4 py-2 font-medium {% if request.path == '/metrics' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
      –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    </a>
    <a href="/activity"
       class="px-4 py-2 font-medium {% if request.path == '/activity' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
      –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    </a>
    <a href="/meals"
       class="px-4 py-2 font-medium {% if request.path == '/meals' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
      –ü—Ä–∏—ë–º—ã –ø–∏—â–∏
    </a>
  </div>

{% if request.path == '/profile' %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">

<div class="lg:col-span-1 space-y-6">

    <div class="card p-6">
        <div class="relative text-center">

            <div class="absolute top-0 right-0">
                <button onclick="openTelegramModal()" title="–°—Ç–∞—Ç—É—Å Telegram" class="p-2 rounded-full hover:bg-slate-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6
                        {% if user.telegram_chat_id %}
                            text-green-500 {% else %}
                            text-slate-400 hover:text-slate-600 {% endif %}"
                        viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                      <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" />
                    </svg>
                </button>
            </div>

            {% if user.avatar %}
<img loading="lazy" width="96" height="96"
     src="{{ url_for('serve_uploaded_file', filename=user.avatar) }}" alt="Avatar"
     class="w-24 h-24 mx-auto rounded-full ring-4 ring-offset-4 ring-blue-200 shadow-lg object-cover">
            {% else %}
<img loading="lazy" width="96" height="96"
     src="https://www.svgrepo.com/show/452070/user-avatar.svg" alt="Default Avatar"
     class="w-24 h-24 mx-auto rounded-full ring-4 ring-offset-4 ring-gray-200 shadow-lg">
            {% endif %}
            <h2 class="mt-5 text-xl font-bold text-slate-900">{{ user.name }}</h2>
<p class="text-sm text-slate-500">{{ user.email }}</p>
<div class="mt-4">
    <button onclick="openEditProfileModal()" class="btn btn-secondary w-full text-sm">
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
    </button>
</div>
        </div>

        <hr class="my-5 border-slate-200">

        <div>
            <div class="flex justify-between items-center cursor-pointer" id="metrics-header">
              <h3 class="text-base font-bold text-slate-800">üìä –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
              <button class="flex items-center gap-1 text-sm font-semibold text-blue-600 hover:text-blue-800">
                <span id="metrics-toggle-text">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</span>
                <svg id="metrics-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 transition-transform duration-300 rotate-180">
                  <path fill-rule="evenodd" d="M14.77 12.79a.75.75 0 01-1.06 0L10 9.06l-3.71 3.73a.75.75 0 11-1.06-1.06l4.24-4.25a.75.75 0 011.06 0l4.24 4.25a.75.75 0 010 1.06z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
            <div id="metrics-icons-view" class="mt-4 grid grid-cols-3 gap-3 text-center">
              {% set key_metrics = [('weight', '‚öñÔ∏è', '–í–µ—Å'), ('muscle_mass', 'üí™', '–ú—ã—à—Ü—ã'), ('fat_mass', 'üßà', '–ñ–∏—Ä')] %}
              {% for field, icon, label in key_metrics %}
                {% set value = latest_analysis[field] if latest_analysis else '‚Äî' %}
                <div class="p-2 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="text-sm text-slate-500">{{ label }}</div>
                    <div class="text-xl font-bold text-slate-800 mt-1">{{ value|float|round(1) if value is not none else '' }}
</div>
                </div>
              {% endfor %}
            </div>
            <div id="metrics-details-view" class="hidden mt-4 space-y-3">
              {% set metrics = [
                  ('–†–æ—Å—Ç', 'height', 'üìè', '—Å–º',  True), ('–í–µ—Å', 'weight', '‚öñÔ∏è', '–∫–≥',  False),
                  ('–ú—ã—à—Ü—ã', 'muscle_mass', 'üí™', '–∫–≥',  True), ('–ñ–∏—Ä', 'fat_mass', 'üßà', '–∫–≥',  False),
                  ('–í–æ–¥–∞', 'body_water', 'üíß', '%',  True), ('–ú–µ—Ç–∞–±–æ–ª–∏–∑–º', 'metabolism', '‚ö°', '–∫–∫–∞–ª',True),
                  ('–ë–µ–ª–æ–∫', 'protein_percentage', 'ü•ö', '%',  True), ('–í–∏—Å—Ü. –∂–∏—Ä', 'visceral_fat_rating', 'üî•', '',   False),
                  ('–ò–ú–¢', 'bmi', 'üìê', '',   False)
              ] %}
              {% for label, field, icon, unit, good_up in metrics %}
                {% set cur = latest_analysis[field] if latest_analysis else none %}
                {% if cur is not none %}
                  <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                    <div class="flex items-center">
                      <span class="text-xl mr-3">{{ icon }}</span>
                      <div>
                        <div class="font-semibold text-slate-700">{{ label }}</div>
                        <div class="text-xl font-bold text-slate-900">{{ cur|round(1) }}<span class="text-sm font-medium text-slate-400 ml-1">{{ unit }}</span></div>
                      </div>
                    </div>
                    {% set prev = previous_analysis[field] if previous_analysis else none %}
                    {% if prev is not none %}{% set cur_f, prev_f = cur|float, prev|float %}{% set diff = cur_f - prev_f %}{% if diff != 0 %}{% set arrow, is_good = ('‚Üë', good_up) if diff > 0 else ('‚Üì', not good_up) %}<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold {% if is_good %} bg-green-100 text-green-700 {% else %} bg-red-100 text-red-700 {% endif %}">{{ arrow }} {{ diff|abs|round(1) }}{{ unit }}</span>{% endif %}{% endif %}
                  </div>
                {% endif %}
              {% endfor %}
              {% if user.analysis_comment %}<div class="!mt-5 p-4 rounded-lg bg-blue-50 border border-blue-200 text-sm text-blue-800"><strong class="font-semibold">üí¨ AI-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {{ user.analysis_comment }}</div>{% endif %}
            </div>
        </div>
    </div>

    {% if user.subscription %}
      <div class="card p-6">
        <h3 class="text-lg font-bold text-slate-800 mb-3">–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏</h3>

        {% if user.subscription.status == 'active' %}
          <div class="p-4 rounded-lg bg-gradient-to-br from-green-400 to-blue-500 text-white shadow-lg">
              <div class="flex items-center justify-between">
                  <span class="font-bold text-lg">üëë –ê–∫—Ç–∏–≤–Ω–∞</span>
                  <span class="text-sm opacity-90">
                      {% if user.subscription.end_date %}
                          –¥–æ {{ user.subscription.end_date.strftime('%d.%m.%Y') }}
                      {% else %}
                          –ë–µ–∑–ª–∏–º–∏—Ç–Ω–∞—è
                      {% endif %}
                  </span>
              </div>
          </div>
          {% if user.subscription.end_date %}
            <form action="{{ url_for('manage_user_subscription') }}" method="POST" class="mt-4">
              <input type="hidden" name="action" value="freeze">
              <button type="submit"
                      onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–º–æ—Ä–æ–∑–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É? –î–æ—Å—Ç—É–ø –∫ –ø–ª–∞—Ç–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º –±—É–¥–µ—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∞ –æ—Å—Ç–∞–≤—à–∏–π—Å—è —Å—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.')"
                      class="btn btn-secondary w-full text-sm">
                  ‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∑–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
              </button>
            </form>
          {% endif %}

        {% elif user.subscription.status == 'frozen' %}
          <div class="p-4 rounded-lg bg-slate-200 text-slate-800 border border-slate-300">
              <div class="flex items-center justify-between">
                  <span class="font-bold text-lg">‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∂–µ–Ω–∞</span>
                  <span class="text-sm font-medium">
                      –û—Å—Ç–∞–ª–æ—Å—å: {{ user.subscription.remaining_days_on_freeze }} –¥–Ω.
                  </span>
              </div>
          </div>
          <form action="{{ url_for('manage_user_subscription') }}" method="POST" class="mt-4">
            <input type="hidden" name="action" value="unfreeze">
            <button type="submit"
                    onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–º–æ—Ä–æ–∑–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É? –°—Ä–æ–∫ –µ–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞—á–Ω–µ—Ç –æ—Ç—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è.')"
                    class="btn btn-primary w-full text-sm">
                üî• –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </form>

        {% else %}
            <div class="p-4 rounded-lg bg-red-100 text-red-800 border border-red-200 text-center">
                <p class="font-semibold">–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ (—Å—Ç–∞—Ç—É—Å: {{ user.subscription.status }})</p>
            </div>
        {% endif %}
      </div>
    {% else %}
      <div class="card p-6 bg-gradient-to-br from-blue-500 to-indigo-600 text-white text-center shadow-xl">
          <h3 class="font-bold text-xl">üöÄ –†–∞—Å—à–∏—Ä—å—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h3>
          <p class="text-sm text-white/80 mt-1 mb-4">–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–µ—Ç, –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º, –æ—Ñ–æ—Ä–º–∏–≤ –ø–æ–¥–ø–∏—Å–∫—É.</p>
          <a href="#" class="btn bg-white text-blue-600 hover:bg-slate-100 w-full">
              –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ
          </a>
      </div>
    {% endif %}

    {% if not user.telegram_chat_id %}
    <div class="card p-6 bg-blue-50 border-blue-200 text-center">
        <h3 class="font-bold text-blue-800">–ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</h3>
        <p class="text-sm text-blue-700 mt-1 mb-4">–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –¥–∏–µ—Ç—É –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä—è–º–æ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä.</p>
        <button onclick="openTelegramModal()" class="btn btn-primary w-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" /></svg>
            –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram
        </button>
    </div>
    {% endif %}
    {% if not current_user.has_subscription %}
<div class="card p-6 bg-green-50 border-green-200 text-center">
    <h3 class="font-bold text-green-800">–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h3>
    <p class="text-sm text-green-700 mt-1 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –Ω–∞—à–∏—Ö –ø–ª–∞–Ω–æ–≤, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–µ—Ç –∏ –¥—Ä—É–≥–∏–º –ø—Ä–µ–º–∏—É–º-—Ñ—É–Ω–∫—Ü–∏—è–º.</p>
    <a href="{{ url_for('purchase_page') }}" class="btn bg-green-600 hover:bg-green-700 text-white w-full">
        ‚ú® –í—ã–±—Ä–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
    </a>
</div>
{% endif %}

    <div class="card p-6 relative">
        <div {% if not current_user.has_subscription %}class="locked-feature"{% endif %}>
            <h3 class="text-lg font-bold mb-3 text-slate-800">–°–æ–æ–±—â–µ—Å—Ç–≤–æ</h3>
            {% if user_joined_group %}
              <a href="{{ url_for('group_detail', group_id=user_joined_group.id) }}" class="block p-4 rounded-lg bg-gradient-to-br from-sky-500 to-indigo-500 text-white shadow-lg hover:shadow-xl transition-shadow">
                <span class="font-semibold text-lg">–ú–æ—è –≥—Ä—É–ø–ø–∞: {{ user_joined_group.name }}</span>
                {% if user_joined_group.description %}<p class="text-sm opacity-80 mt-1">{{ user_joined_group.description }}</p>{% endif %}
                <span class="block text-xs mt-3 opacity-90">–ü–µ—Ä–µ–π—Ç–∏ –≤ –≥—Ä—É–ø–ø—É ‚Üí</span>
              </a>
            {% else %}
              <div class="text-center p-4 border-2 border-dashed border-slate-300 rounded-lg">
                <p class="text-slate-600 mb-3">–í—ã –µ—â–µ –Ω–µ –≤ –≥—Ä—É–ø–ø–µ. –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ—é –∫–æ–º–∞–Ω–¥—É!</p>
                <a href="{{ url_for('groups_list') }}" class="btn btn-primary w-full">–í—Å—Ç—É–ø–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å</a>
              </div>
            {% endif %}
        </div>
        {% if not current_user.has_subscription %}
        <div class="locked-overlay">
            <div class="locked-icon">üîí</div>
            <p class="locked-text">–î–æ—Å—Ç—É–ø –∫ –≥—Ä—É–ø–ø–∞–º</p>
            <p class="text-sm text-slate-600 mb-3">–æ—Ç–∫—Ä—ã—Ç –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
<a href="{{ url_for('purchase_page') }}" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</a>
        </div>
        {% endif %}
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-slate-800 mb-3">–ù–æ–≤—ã–π –∑–∞–º–µ—Ä —Ç–µ–ª–∞</h3>
        <form id="uploadForm" action="/upload_analysis" method="POST" enctype="multipart/form-data">
              <input type="file" name="file" accept=".pdf,.png,.jpg,.jpeg" required class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <button type="submit" class="btn btn-primary w-full mt-3">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å</button>
        </form>
    </div>
</div>
    <div class="lg:col-span-2 space-y-6">


      {% if fat_loss_progress and current_user.has_subscription %}
      <div class="card p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="showDeficitHistory()">
        <h3 class="text-lg font-bold text-slate-800 mb-1">üî• –ü—Ä–æ–≥—Ä–µ—Å—Å –∂–∏—Ä–æ—Å–∂–∏–≥–∞–Ω–∏—è</h3>
        <p class="text-sm text-slate-500 mb-4">–ù–∞ –æ—Å–Ω–æ–≤–µ —Å—É–º–º–∞—Ä–Ω–æ–≥–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∫–∞–ª–æ—Ä–∏–π.</p>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" style="width: {{ fat_loss_progress.percentage }}%;"></div>
        </div>
        <div class="flex justify-between items-center mt-2 text-sm font-medium">
          <span class="text-slate-500">–°—Ç–∞—Ä—Ç: {{ fat_loss_progress.initial_kg|round(1) }} –∫–≥</span>
          <span class="font-bold text-orange-600">{{ fat_loss_progress.percentage|round(1) }}%</span>
          <span class="text-slate-500">–¶–µ–ª—å: {{ fat_loss_progress.goal_kg|round(1) }} –∫–≥</span>
        </div>
        <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-3 text-center">
            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                <div class="text-xs text-slate-500">–°–æ–∂–∂–µ–Ω–æ</div>
                <div class="text-lg font-bold text-green-600">{{ fat_loss_progress.burned_kg|round(2) }} –∫–≥</div>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                <div class="text-xs text-slate-500">–û—Å—Ç–∞–ª–æ—Å—å</div>
                <div class="text-lg font-bold text-red-600">{{ (fat_loss_progress.total_to_lose_kg - fat_loss_progress.burned_kg)|round(2) }} –∫–≥</div>
            </div>
             <div class="bg-slate-50 rounded-lg p-3 border border-slate-200 col-span-2 sm:col-span-1">
                <div class="text-xs text-slate-500">–†–∞—Å—á–µ—Ç–Ω—ã–π –≤–µ—Å –∂–∏—Ä–∞</div>
                <div class="text-lg font-bold text-slate-700">{{ fat_loss_progress.current_kg|round(1) }} –∫–≥</div>
            </div>
        </div>
      </div>
      {% endif %}

<div class="card p-6 relative">
        <div {% if not current_user.has_subscription %}class="locked-feature"{% endif %}>
            <h3 class="text-lg font-bold text-slate-800 mb-4">–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
           <div class="grid md:grid-cols-3 gap-6 text-center">
    <div>
        <div class="text-sm font-semibold text-slate-600 mb-2">–í–µ—Å, –∫–≥</div>
        <div class="relative h-24 w-full">
            <canvas id="weightChart"></canvas>
        </div>
    </div>
    <div>
        <div class="text-sm font-semibold text-slate-600 mb-2">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ, –∫–∫–∞–ª</div>
        <div class="relative h-24 w-full">
            <canvas id="mealsChart"></canvas>
        </div>
    </div>
    <div>
        <div class="text-sm font-semibold text-slate-600 mb-2">–°–æ–∂–∂–µ–Ω–æ, –∫–∫–∞–ª</div>
        <div class="relative h-24 w-full">
            <canvas id="activityChart"></canvas>
        </div>
    </div>
</div>
        </div>
        {% if not current_user.has_subscription %}
        <div class="locked-overlay">
            <div class="locked-icon">üìä</div>
            <p class="locked-text">–í–∏–∑—É–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
            <p class="text-sm text-slate-600 mb-3">–¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
<a href="{{ url_for('purchase_page') }}" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å PRO</a>
        </div>
        {% endif %}
    </div>
    <div id="diet-card-container" class="card p-6 relative">

          <div id="diet-display-section" {% if not diet %}style="display: none;"{% endif %}>
              <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold text-slate-800">üìà –í–∞—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω</h3>
                  <button onclick="confirmAndResetDiet()" class="text-sm font-semibold text-red-500 hover:text-red-700">
                      –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
                  </button>
              </div>

              {% if diet %}
              <a href="/diet" class="block space-y-4">
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center text-slate-700">
                      <div class="bg-green-50 py-2 rounded-lg border border-green-200"><div class="text-xs text-green-800">–ö–∞–ª–æ—Ä–∏–∏</div><div class="font-bold">{{ diet.total_kcal }} –∫–∫–∞–ª</div></div>
                      <div class="bg-blue-50 py-2 rounded-lg border border-blue-200"><div class="text-xs text-blue-800">–ë–µ–ª–∫–∏</div><div class="font-bold">{{ diet.protein }} –≥</div></div>
                      <div class="bg-yellow-50 py-2 rounded-lg border border-yellow-200"><div class="text-xs text-yellow-800">–ñ–∏—Ä—ã</div><div class="font-bold">{{ diet.fat }} –≥</div></div>
                      <div class="bg-purple-50 py-2 rounded-lg border border-purple-200"><div class="text-xs text-purple-800">–£–≥–ª–µ–≤–æ–¥—ã</div><div class="font-bold">{{ diet.carbs }} –≥</div></div>
                  </div>
                  {% for meal_name, meal_items in {
                      'üç≥ –ó–∞–≤—Ç—Ä–∞–∫': breakfast, 'üç≤ –û–±–µ–¥': lunch, 'üçù –£–∂–∏–Ω': dinner, 'üçé –ü–µ—Ä–µ–∫—É—Å': snack
                  }.items() %}
                  <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
                    <div class="font-semibold text-slate-700 mb-2 text-sm">{{ meal_name }}</div>
                    <ul class="space-y-1 text-sm text-slate-600">
                    {% for itm in meal_items %}
                      <li class="flex justify-between"><span>{{ itm.name }}</span><span class="text-xs text-slate-500">{{ itm.grams }}–≥, {{ itm.kcal }} –∫–∫–∞–ª</span></li>
                    {% else %}
                       <li class="text-slate-400 text-xs">–ù–µ—Ç –±–ª—é–¥ –≤ —ç—Ç–æ–º –ø—Ä–∏—ë–º–µ.</li>
                    {% endfor %}
                    </ul>
                  </div>
                  {% endfor %}
              </a>
              {% endif %}
          </div>

          <div id="diet-generation-section" {% if diet %}style="display: none;"{% endif %}>
              <div {% if not current_user.has_subscription %}class="locked-feature"{% endif %}>
                  <h3 class="text-lg font-bold text-slate-800 mb-4">üìà –°–æ–∑–¥–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω</h3>

                  {% if latest_analysis and latest_analysis.height and latest_analysis.weight %}
                    <form id="dietForm" class="space-y-6">
                      <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">–í–∞—à–∞ —Ü–µ–ª—å</label>
                        <div class="grid grid-cols-3 gap-3">
                          {% for g in [{'label': '–ù–∞–±–æ—Ä', 'icon': 'üí™', 'value': 'muscle'},{'label': '–ü–æ—Ö—É–¥–µ–Ω–∏–µ', 'icon': 'üî•', 'value': 'loss'},{'label': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ', 'icon': '‚öñÔ∏è', 'value': 'maintain'}] %}
                            <div class="selection-card text-center" data-group="goal" data-value="{{ g.value }}">
                              <div class="text-3xl">{{ g.icon }}</div><div class="text-sm mt-1 font-semibold">{{ g.label }}</div>
                            </div>
                          {% endfor %}
                        </div>
                        <input type="hidden" name="goal" id="goalInput">
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">–í–∞—à –ø–æ–ª</label>
                        <div class="grid grid-cols-2 gap-3">
                          {% for g in [{'label': '–ú—É–∂—Å–∫–æ–π', 'icon': '‚ôÇÔ∏è', 'value': 'male'},{'label': '–ñ–µ–Ω—Å–∫–∏–π', 'icon': '‚ôÄÔ∏è', 'value': 'female'}] %}
                            <div class="selection-card text-center" data-group="gender" data-value="{{ g.value }}">
                              <span class="text-xl mr-2">{{ g.icon }}</span><span class="font-semibold">{{ g.label }}</span>
                            </div>
                          {% endfor %}
                        </div>
                        <input type="hidden" name="gender" id="genderInput">
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea name="preferences" rows="2" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ —Ä—ã–±—ã, –±–æ–ª—å—à–µ –∫—É—Ä–∏—Ü—ã"></textarea>
                      </div>
                      <button type="button" onclick="startDietGeneration()" class="btn btn-primary w-full">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω</button>
                    </form>
                  {% else %}
                    <p class="text-center text-slate-500 py-8">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –≤–∞—Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω.</p>
                  {% endif %}
               </div>
               {% if not current_user.has_subscription %}
               <div class="locked-overlay">
                   <div class="locked-icon">üçΩÔ∏è</div>
                   <p class="locked-text">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –¥–∏–µ—Ç–∞</p>
                   <p class="text-sm text-slate-600 mb-3">–¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
                   <a href="#" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</a>
               </div>
               {% endif %}
          </div>
      </div>
    </div>
  </div>

   {% elif request.path == '/metrics' %}
  <div class="space-y-6 animate-fade-in">
    <div class="card p-6">
      <h2 class="text-xl font-bold mb-4">–ë–∞–ª–∞–Ω—Å –∫–∞–ª–æ—Ä–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
      {% if missing_meals or missing_activity %}
        <div class="text-center py-8 bg-yellow-50 border border-yellow-200 rounded-lg">
          <h3 class="font-semibold text-yellow-800">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞</h3>
          <p class="text-sm text-yellow-700 mt-1">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:</p>
          <ul class="list-disc list-inside text-sm text-yellow-700 mt-2">
            {% if missing_meals %}<li>–ü—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</li>{% endif %}
            {% if missing_activity %}<li>–î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</li>{% endif %}
          </ul>
        </div>
      {% else %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div class="bg-slate-50 p-4 rounded-lg"><div class="text-sm text-slate-500">–ú–µ—Ç–∞–±–æ–ª–∏–∑–º</div><div class="text-2xl font-bold text-slate-800">{{ metabolism }}</div><span class="text-xs text-slate-500">–∫–∫–∞–ª</span></div>
          <div class="bg-slate-50 p-4 rounded-lg"><div class="text-sm text-slate-500">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div><div class="text-2xl font-bold text-blue-600">+ {{ active_kcal }}</div><span class="text-xs text-slate-500">–∫–∫–∞–ª</span></div>
          <div class="bg-slate-50 p-4 rounded-lg"><div class="text-sm text-slate-500">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ</div><div class="text-2xl font-bold text-orange-600">- {{ total_meals }}</div><span class="text-xs text-slate-500">–∫–∫–∞–ª</span></div>
          <div class="bg-green-50 p-4 rounded-lg border border-green-200"><div class="text-sm text-green-700">–î–µ—Ñ–∏—Ü–∏—Ç</div><div class="text-2xl font-bold text-green-600">{{ deficit }}</div><span class="text-xs text-green-600">–∫–∫–∞–ª</span></div>
        </div>
      {% endif %}
    </div>

    <div class="grid md:grid-cols-2 gap-6">
        <div class="card p-6">
          <h3 class="text-lg font-bold mb-4">üèÉ‚Äç‚ôÇÔ∏è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-slate-50 p-4 rounded-lg text-center"><div class="text-sm text-slate-500">–®–∞–≥–∏</div><div class="text-xl font-bold">{{ steps or '‚Äî' }}</div></div>
            <div class="bg-slate-50 p-4 rounded-lg text-center"><div class="text-sm text-slate-500">–î–∏—Å—Ç–∞–Ω—Ü–∏—è</div><div class="text-xl font-bold">{{ distance_km or '‚Äî' }} <span class="text-sm">–∫–º</span></div></div>
            <div class="bg-slate-50 p-4 rounded-lg text-center"><div class="text-sm text-slate-500">–ê–∫—Ç–∏–≤. –∫–∞–ª–æ—Ä–∏–∏</div><div class="text-xl font-bold">{{ active_kcal or '‚Äî' }}</div></div>
            <div class="bg-slate-50 p-4 rounded-lg text-center"><div class="text-sm text-slate-500">–ö–∞–ª–æ—Ä–∏–∏ –ø–æ–∫–æ—è</div><div class="text-xl font-bold">{{ resting_kcal or '‚Äî' }}</div></div>
          </div>
        </div>

        <div class="card p-6">
          <h3 class="text-lg font-bold mb-4">üçΩÔ∏è –ü—Ä–∏—ë–º—ã –ø–∏—â–∏ —Å–µ–≥–æ–¥–Ω—è</h3>
          {% if today_meals %}
          <div class="grid grid-cols-2 gap-4">
            {% for meal in today_meals %}
              <div class="bg-slate-50 p-4 rounded-lg text-center">
                <div class="text-sm text-slate-500 font-semibold">{{ meal.meal_type|capitalize }}</div>
                <div class="mt-1 text-xl font-bold">{{ meal.calories }} <span class="text-sm">–∫–∫–∞–ª</span></div>
              </div>
            {% endfor %}
          </div>
          {% else %}
            <p class="text-center text-slate-500 py-6">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—ë–º–∞—Ö –ø–∏—â–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.</p>
          {% endif %}
        </div>
    </div>
  </div>

  {% elif request.path == '/activity' %}
  <div class="card p-6 animate-fade-in">
    <h2 class="text-xl font-bold mb-6">–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
    {% if today_activity %}
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg"><div class="text-sm text-slate-500">üëü –®–∞–≥–∏</div><div class="text-2xl font-bold mt-1">{{ today_activity.steps or '‚Äî' }}</div></div>
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg"><div class="text-sm text-slate-500">üó∫Ô∏è –î–∏—Å—Ç–∞–Ω—Ü–∏—è</div><div class="text-2xl font-bold mt-1">{{ today_activity.distance_km or '‚Äî' }} –∫–º</div></div>
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg"><div class="text-sm text-slate-500">üî• –ö–∞–ª–æ—Ä–∏–∏</div><div class="text-2xl font-bold mt-1">{{ today_activity.active_kcal or '‚Äî' }}</div></div>
        <div class="bg-slate-50 border border-slate-200 p-4 rounded-lg"><div class="text-sm text-slate-500">‚ù§Ô∏è –ü—É–ª—å—Å (—Å—Ä–µ–¥.)</div><div class="text-2xl font-bold mt-1">{{ today_activity.heart_rate_avg or '‚Äî' }} <span class="text-base">—É–¥/–º–∏–Ω</span></div></div>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-6">
          <div class="p-4 bg-slate-50 rounded-lg"><h3 class="font-semibold mb-2">–ì—Ä–∞—Ñ–∏–∫ —à–∞–≥–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</h3><div class="h-48 flex items-center justify-center text-slate-400">[–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥—Ä–∞—Ñ–∏–∫–∞]</div></div>
          <div class="p-4 bg-slate-50 rounded-lg"><h3 class="font-semibold mb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏ –ø–æ –¥–Ω—è–º</h3><div class="h-48 flex items-center justify-center text-slate-400">[–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥—Ä–∞—Ñ–∏–∫–∞]</div></div>
        </div>
        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg h-fit">
          <h3 class="font-semibold text-blue-800">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö</h3>
          <div class="flex items-center mt-3">
             <div class="bg-white p-3 rounded-full mr-4 shadow">
                  <span class="text-xl">üì±</span>
             </div>
             <div>
                <div class="font-bold text-blue-900">{{ today_activity.source or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                <div class="text-sm text-blue-700">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ today_activity.date.strftime('%H:%M') }}</div>
             </div>
          </div>
        </div>
      </div>

    {% else %}
      <div class="text-center py-16">
        <div class="text-5xl text-slate-300 mb-4">üìä</div>
        <p class="text-slate-500 font-semibold">–î–∞–Ω–Ω—ã–µ –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        <p class="text-sm text-slate-400 mt-2">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä, Apple Health –∏–ª–∏ Google Fit.</p>
      </div>
    {% endif %}
  </div>

{% elif request.path == '/meals' %}
<div class="space-y-8 animate-fade-in">

    <div>
        <h2 class="text-2xl font-bold text-slate-800 mb-4">–°–≤–æ–¥–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
        <div class="card p-6">
            {% set all_items = meals.values() | sum(start=[]) %}

            {% set today_total_kcal    = all_items | sum(attribute='calories') %}
            {% set today_total_protein = all_items | sum(attribute='protein') %}
            {% set today_total_fat     = all_items | sum(attribute='fat') %}
            {% set today_total_carbs   = all_items | sum(attribute='carbs') %}

            {% set goal_kcal = latest_analysis.metabolism + 500 if latest_analysis and latest_analysis.metabolism else 2000 %}
            {% set progress_percent = (today_total_kcal / goal_kcal * 100) | round if goal_kcal > 0 else 0 %}

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                <div>
                    <div class="text-sm text-slate-500">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ –∫–∞–ª–æ—Ä–∏–π</div>
                    <span class="text-3xl font-bold text-slate-900">{{ today_total_kcal }}</span>
                    <span class="text-lg text-slate-400 font-medium">/ {{ goal_kcal }} –∫–∫–∞–ª</span>
                </div>
                <div class="w-full sm:w-1/3">
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ progress_percent }}%"></div>
                    </div>
                </div>
            </div>

            <hr class="my-5 border-slate-200">

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="text-sm font-semibold text-blue-800">–ë–µ–ª–∫–∏</div>
                    <div class="text-xl font-bold text-blue-900 mt-1">{{ today_total_protein | round(1) }} –≥</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div class="text-sm font-semibold text-yellow-800">–ñ–∏—Ä—ã</div>
                    <div class="text-xl font-bold text-yellow-900 mt-1">{{ today_total_fat | round(1) }} –≥</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                    <div class="text-sm font-semibold text-purple-800">–£–≥–ª–µ–≤–æ–¥—ã</div>
                    <div class="text-xl font-bold text-purple-900 mt-1">{{ today_total_carbs | round(1) }} –≥</div>
                </div>
            </div>
        </div>
    </div>

    <div>
        <h2 class="text-2xl font-bold text-slate-800 mb-4">–ü—Ä–∏—ë–º—ã –ø–∏—â–∏</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for meal_name, key, gradient in [
              ('–ó–∞–≤—Ç—Ä–∞–∫', 'breakfast', 'from-amber-400 to-orange-500'),
              ('–û–±–µ–¥',    'lunch',     'from-green-400 to-emerald-500'),
              ('–£–∂–∏–Ω',    'dinner',    'from-blue-500 to-indigo-600'),
              ('–ü–µ—Ä–µ–∫—É—Å', 'snack',     'from-pink-400 to-rose-500')
            ] %}
              {% set item = meals.get(key, []) | first %}

              <div class="flip-card" onclick="this.classList.toggle('is-flipped')">
                <div class="flip-card-inner">
                  <div class="flip-card-front">
                    <div class="p-6 bg-gradient-to-br {{ gradient }} text-white">
                      <div class="flex justify-between items-center">
                          <h3 class="text-xl font-bold">{{ meal_name }}</h3>
                          {% if item %}
                            <span class="text-lg font-bold">{{ item.calories }} <span class="text-sm font-normal opacity-80">–∫–∫–∞–ª</span></span>
                          {% endif %}
                      </div>
                    </div>
                    <div class="p-6 flex-grow flex flex-col justify-center items-center">
                      {% if item %}
                        <p class="text-lg font-semibold text-slate-800">{{ item.name or '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
                        <span class="text-xs text-slate-400 mt-4">(–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏)</span>
                      {% else %}
                        <p class="text-slate-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                      {% endif %}
                    </div>
                    <div class="p-4 border-t border-slate-200">
                      <button onclick="event.stopPropagation(); openMealModal('{{ key }}','{{ meal_name }}')"
                              class="btn w-full {% if item %}btn-secondary{% else %}btn-primary{% endif %}">
                        ‚úèÔ∏è {% if item %}–ò–∑–º–µ–Ω–∏—Ç—å{% else %}–î–æ–±–∞–≤–∏—Ç—å{% endif %}
                      </button>
                    </div>
                  </div>
                  <div class="flip-card-back">
                    {% if item %}
                      <h4 class="font-bold text-lg mb-2">–í–µ—Ä–¥–∏–∫—Ç AI</h4>
                      <p class="text-sm text-center mb-4 bg-white/70 p-3 rounded-md">{{ item.verdict or '–ù–µ—Ç –≤–µ—Ä–¥–∏–∫—Ç–∞.' }}</p>
                      <h4 class="font-bold text-lg mb-2">–ê–Ω–∞–ª–∏–∑</h4>
                      <p class="text-xs text-slate-600 text-center">{{ item.analysis or '–ù–µ—Ç –∞–Ω–∞–ª–∏–∑–∞.' }}</p>
                    {% else %}
                        <p>–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –±–ª—é–¥–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é.</p>
                    {% endif %}
                  </div>

                </div>
              </div>
            {% endfor %}
        </div>
    </div>
</div>
    </div>
</div>

{%- macro sum(items, attribute, sum_key=false) -%}
  {% if sum_key %}
    {{ items | map('sum', attribute=attribute) | sum }}
  {% else %}
    {{ items | sum(attribute=attribute) }}
  {% endif %}
{%- endmacro -%}
{% endif %}

<div id="mealModal" role="dialog" aria-modal="true" aria-labelledby="modalMealTitle"
     class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="closeMealModal()">
  <div class="card w-full max-w-md p-0 relative animate-fade-in" onclick="event.stopPropagation()">
    <button onclick="closeMealModal()" class="absolute top-3 right-4 text-slate-500 text-2xl hover:text-slate-700 z-20">&times;</button>

    <div class="p-6">
      <h2 class="text-xl font-bold">–ü—Ä–∏—ë–º –ø–∏—â–∏: <span id="modalMealTitle"></span></h2>
    </div>

    <div class="flex border-b border-slate-200 px-6">
      <button id="manualTabBtn" onclick="switchMealTab('manual')" class="meal-tab active">
        ‚úçÔ∏è –í—Ä—É—á–Ω—É—é
      </button>
      <button id="aiTabBtn" onclick="switchMealTab('ai')" class="meal-tab">
        üì∏ –ê–Ω–∞–ª–∏–∑ –ø–æ —Ñ–æ—Ç–æ {% if not current_user.has_subscription %}<span class="text-amber-500">(PRO)</span>{% endif %}
      </button>
    </div>

    <div class="p-6">
      <div id="manualTabContent">
        <form id="manualMealForm" method="POST" action="/meals" class="space-y-4">
          <input type="hidden" name="meal_type" id="manualMealType">

          <div>
            <label for="manualName" class="block text-sm font-medium mb-1 text-slate-700">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞</label>
            <input type="text" id="manualName" name="name" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –û–≤—Å—è–Ω–∞—è –∫–∞—à–∞" required>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
                <label for="manualCalories" class="block text-sm font-medium mb-1 text-slate-700">–ö–∞–ª–æ—Ä–∏–∏</label>
                <input type="number" id="manualCalories" name="calories" class="form-input" placeholder="–∫–∫–∞–ª" required>
            </div>
            <div>
                <label for="manualProtein" class="block text-sm font-medium mb-1 text-slate-700">–ë–µ–ª–∫–∏</label>
                <input type="number" step="0.1" id="manualProtein" name="protein" class="form-input" placeholder="–≥—Ä–∞–º–º—ã" required>
            </div>
            <div>
                <label for="manualFat" class="block text-sm font-medium mb-1 text-slate-700">–ñ–∏—Ä—ã</label>
                <input type="number" step="0.1" id="manualFat" name="fat" class="form-input" placeholder="–≥—Ä–∞–º–º—ã" required>
            </div>
            <div>
                <label for="manualCarbs" class="block text-sm font-medium mb-1 text-slate-700">–£–≥–ª–µ–≤–æ–¥—ã</label>
                <input type="number" step="0.1" id="manualCarbs" name="carbs" class="form-input" placeholder="–≥—Ä–∞–º–º—ã" required>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>

      <div id="aiTabContent" class="hidden relative">
          <div {% if not current_user.has_subscription %}class="locked-feature"{% endif %}>
            <div class="space-y-4">
              <input type="file" id="mealFileInput" accept="image/*" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
              <button id="analyzeMealBtn" onclick="analyzeMeal()" class="btn btn-primary w-full">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ</button>

              <div id="mealLoading" class="flex items-center justify-center space-x-2 hidden text-slate-500">
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                <span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...</span>
              </div>

              <div id="mealAnalysisResult" class="hidden space-y-3">
                 </div>
            </div>
          </div>
          {% if not current_user.has_subscription %}
            <div class="locked-overlay">
                <div class="locked-icon">üì∏</div>
                <p class="locked-text">AI-–∞–Ω–∞–ª–∏–∑ –ø–æ —Ñ–æ—Ç–æ</p>
                <p class="text-sm text-slate-600 mb-3">–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</p>
                <a href="#" class="btn btn-primary btn-sm">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å PRO</a>
            </div>
          {% endif %}
      </div>
    </div>
  </div>
</div>

<div id="dietLoader" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50 hidden">
  <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
  <p class="mt-4 text-lg font-semibold text-slate-700">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—à –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω...</p>
  <p class="text-slate-500">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥.</p>
</div>

<div id="telegramModal" role="dialog" aria-modal="true" aria-labelledby="telegramModalTitle"
     class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
  <div class="card w-full max-w-md p-6 relative space-y-4 text-center animate-fade-in" onclick="event.stopPropagation()">
    <button onclick="closeTelegramModal()" class="absolute top-4 right-4 text-slate-400 text-2xl hover:text-slate-600">&times;</button>
<h2 id="telegramModalTitle" class="text-xl font-bold">üîê –ü—Ä–∏–≤—è–∑–∫–∞ Telegram</h2>
    <p class="text-slate-600 text-sm">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ <a href="https://t.me/TestKilogrBot" target="_blank" class="font-semibold text-blue-600 underline">Telegram-–±–æ—Ç–∞</a>, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã:</p>
    <div class="bg-slate-100 rounded-lg px-4 py-3 text-2xl font-mono tracking-widest inline-block border border-slate-200" id="tgCodeDisplay">...</div>
    <button onclick="copyCode()" class="btn btn-secondary w-full">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
  </div>
</div>

<div id="editProfileModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="closeEditProfileModal()">
  <div class="card w-full max-w-lg p-6 sm:p-8 relative animate-fade-in" onclick="event.stopPropagation()">
    <button onclick="closeEditProfileModal()" class="absolute top-4 right-4 text-slate-400 text-2xl hover:text-slate-600">&times;</button>
    <h2 class="text-xl font-bold mb-6">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>

    <form action="/edit_profile" method="POST" enctype="multipart/form-data" class="space-y-5">

        <div class="flex items-center gap-4">
            {% if user.avatar %}
              <img src="{{ url_for('serve_uploaded_file', filename=user.avatar) }}" alt="Avatar" class="w-16 h-16 rounded-full object-cover">
            {% else %}
              <img src="https://www.svgrepo.com/show/452070/user-avatar.svg" alt="Default Avatar" class="w-16 h-16 rounded-full">
            {% endif %}
            <div>
                <label for="avatar" class="block text-sm font-medium text-slate-700">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
                <input type="file" name="avatar" id="avatar" accept="image/*" class="mt-1 text-sm text-slate-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
        </div>

        <hr>

        <div class="grid sm:grid-cols-2 gap-4">
            <div>
                <label for="name" class="block text-sm font-medium mb-1 text-slate-700">–ò–º—è</label>
                <input type="text" name="name" id="name" value="{{ user.name }}" class="form-input" required>
            </div>
            <div>
                <label for="email" class="block text-sm font-medium mb-1 text-slate-700">Email</label>
                <input type="email" name="email" id="email" value="{{ user.email }}" class="form-input" required>
            </div>
        </div>

        <div>
          <label for="date_of_birth" class="block text-sm font-medium mb-1 text-slate-700">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" name="date_of_birth" id="date_of_birth" value="{{ user.date_of_birth.strftime('%Y-%m-%d') if user.date_of_birth else '' }}" class="form-input" required>
        </div>

        <hr>

        <p class="text-sm text-slate-600">–û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª—è –Ω–∏–∂–µ –ø—É—Å—Ç—ã–º–∏, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª—å.</p>

        <div class="grid sm:grid-cols-2 gap-4">
             <div>
                <label for="new_password" class="block text-sm font-medium mb-1 text-slate-700">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" name="new_password" id="new_password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div>
                <label for="confirm_password" class="block text-sm font-medium mb-1 text-slate-700">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                <input type="password" name="confirm_password" id="confirm_password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
        </div>

        <div class="flex justify-end gap-3 pt-4">
            <button type="button" onclick="closeEditProfileModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </form>
  </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.meal-tab {
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
    cursor: pointer;
}
.meal-tab:hover {
    color: var(--brand-primary);
}
.meal-tab.active {
    color: var(--brand-primary);
    border-bottom-color: var(--brand-primary);
}
</style>

<script>
    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞ ---
    const banner = document.getElementById('infoBanner');
    const restoreContainer = document.getElementById('restoreBannerContainer');
    if (banner && restoreContainer) {
        if (localStorage.getItem('infoBannerHidden') === 'true') {
            banner.style.display = 'none';
            restoreContainer.style.display = 'block';
        }
    }
    function hideBanner() {
        localStorage.setItem('infoBannerHidden', 'true');
        banner.style.transition = 'opacity 0.5s, transform 0.5s';
        banner.style.opacity = '0';
        banner.style.transform = 'scale(0.95)';
        setTimeout(() => {
            banner.style.display = 'none';
            restoreContainer.style.display = 'block';
        }, 500);
    }
    function showBanner() {
        localStorage.removeItem('infoBannerHidden');
        restoreContainer.style.display = 'none';
        banner.style.display = 'block';
        setTimeout(() => {
            banner.style.transition = 'opacity 0.5s, transform 0.5s';
            banner.style.opacity = '1';
            banner.style.transform = 'scale(1)';
        }, 10);
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ ---
    let currentMealKey = '';

    function switchMealTab(tabName) {
        document.getElementById('manualTabContent').classList.add('hidden');
        document.getElementById('aiTabContent').classList.add('hidden');
        document.getElementById('manualTabBtn').classList.remove('active');
        document.getElementById('aiTabBtn').classList.remove('active');

        if (tabName === 'manual') {
            document.getElementById('manualTabContent').classList.remove('hidden');
            document.getElementById('manualTabBtn').classList.add('active');
        } else {
            document.getElementById('aiTabContent').classList.remove('hidden');
            document.getElementById('aiTabBtn').classList.add('active');
        }
    }

    function openMealModal(key, title) {
        currentMealKey = key;
        document.getElementById('modalMealTitle').textContent = title;
        document.getElementById('manualMealType').value = key;
        document.getElementById('mealAnalysisResult').innerHTML = '';
        document.getElementById('mealFileInput').value = '';
        document.getElementById('mealLoading').classList.add('hidden');
        document.getElementById('analyzeMealBtn').disabled = false;
        document.getElementById('manualMealForm').reset();
        switchMealTab('manual');
        openModal('mealModal');

    }

    function closeMealModal() {
   closeModal('mealModal');

    }

    function analyzeMeal() {
        const fileInput = document.getElementById('mealFileInput');
        if (!fileInput.files.length) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –±–ª—é–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        document.getElementById('analyzeMealBtn').disabled = true;
        document.getElementById('mealLoading').classList.remove('hidden');
        document.getElementById('mealAnalysisResult').innerHTML = '';

        fetch('/analyze_meal_photo', { method: 'POST', body: formData })
            .then(response => {
                if (response.status === 403) {
                    alert('–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ.');
                    return null;
                }
                if (!response.ok) { throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.'); }
                return response.json();
            })
            .then(data => {
                document.getElementById('mealLoading').classList.add('hidden');
                document.getElementById('analyzeMealBtn').disabled = false;
                if (!data) return;
                if (data.error) {
                    alert(`–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${data.error}`);
                    return;
                }

                const resultHtml = `
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                      <div class="text-lg font-bold text-slate-800">${data.name}</div>
                      <p class="text-sm text-slate-600 mt-2">${data.verdict}</p>
                      <div class="grid grid-cols-2 gap-2 text-center mt-3 text-sm">
                        <div class="bg-green-100 text-green-800 p-2 rounded-lg">–ö–∞–ª–æ—Ä–∏–∏: <span class="font-bold">${data.calories}</span> –∫–∫–∞–ª</div>
                        <div class="bg-blue-100 text-blue-800 p-2 rounded-lg">–ë–µ–ª–∫–∏: <span class="font-bold">${data.protein}</span> –≥</div>
                        <div class="bg-yellow-100 text-yellow-800 p-2 rounded-lg">–ñ–∏—Ä—ã: <span class="font-bold">${data.fat}</span> –≥</div>
                        <div class="bg-purple-100 text-purple-800 p-2 rounded-lg">–£–≥–ª–µ–≤–æ–¥—ã: <span class="font-bold">${data.carbs}</span> –≥</div>
                      </div>
                    </div>
                    <form id="confirmMealForm" method="POST" action="/meals">
                      <input type="hidden" name="meal_type" value="${currentMealKey}">
                      <input type="hidden" name="name" value="${data.name}">
                      <input type="hidden" name="verdict" value="${data.verdict}">
                      <input type="hidden" name="calories" value="${data.calories}">
                      <input type="hidden" name="protein" value="${data.protein}">
                      <input type="hidden" name="fat" value="${data.fat}">
                      <input type="hidden" name="carbs" value="${data.carbs}">
                      <input type="hidden" name="analysis" value="${data.analysis}">
                      <button type="submit" class="btn bg-green-600 text-white hover:bg-green-700 w-full mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏</button>
                    </form>
                `;
                document.getElementById('mealAnalysisResult').innerHTML = resultHtml;
                document.getElementById('mealAnalysisResult').classList.remove('hidden');
            })
            .catch(error => {
                document.getElementById('mealLoading').classList.add('hidden');
                document.getElementById('analyzeMealBtn').disabled = false;
                alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`);
            });
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–µ—Ç—ã ---
    function startDietGeneration() {
        const goal = document.getElementById('goalInput').value;
        const gender = document.getElementById('genderInput').value;
        const preferences = document.querySelector('textarea[name="preferences"]').value;

        if (!goal || !gender) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –∏ –ø–æ–ª.');
            return;
        }

        const loader = document.getElementById('dietLoader');
        loader.classList.remove('hidden');

        const params = new URLSearchParams({ goal, gender, preferences });
        fetch('/generate_diet?' + params)
            .then(res => res.json())
            .then(data => {
                loader.classList.add('hidden');
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + JSON.stringify(data));
                }
            })
            .catch(err => {
                loader.classList.add('hidden');
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + err.message);
            });
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ Telegram ---
    function openTelegramModal() {
        fetch('/generate_telegram_code')
            .then(res => res.json())
            .then(data => {
                if (data.code) {
                    document.getElementById('tgCodeDisplay').textContent = data.code;
                    openModal('telegramModal');

                } else { alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥.'); }
            })
            .catch(err => alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞: ' + err.message));
    }

    function closeTelegramModal() {
        closeModal('telegramModal');

    }

    function copyCode() {
        const code = document.getElementById('tgCodeDisplay').textContent;
        navigator.clipboard.writeText(code).then(() => {
            alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        });
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.selection-card').forEach(card => {
            card.addEventListener('click', () => {
                const group = card.dataset.group;
                document.querySelectorAll(`.selection-card[data-group="${group}"]`).forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                document.getElementById(`${group}Input`).value = card.dataset.value;
            });
        });

        const metricsHeader = document.getElementById('metrics-header');
        if (metricsHeader) {
            const detailsView = document.getElementById('metrics-details-view');
            const iconsView = document.getElementById('metrics-icons-view');
            const toggleText = document.getElementById('metrics-toggle-text');
            const toggleIcon = document.getElementById('metrics-toggle-icon');
            metricsHeader.addEventListener('click', () => {
                const isCollapsed = detailsView.classList.contains('hidden');
                detailsView.classList.toggle('hidden', !isCollapsed);
                iconsView.classList.toggle('hidden', isCollapsed);
                toggleText.textContent = isCollapsed ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–í—Å–µ –¥–∞–Ω–Ω—ã–µ';
                toggleIcon.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)';
            });
        }
    });

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è ---
    const editProfileModal = document.getElementById('editProfileModal');
    function openEditProfileModal() {
        if (editProfileModal) {
            openModal('editProfileModal');

        }
    }
    function closeEditProfileModal() {
        if (editProfileModal) {
            closeModal('editProfileModal');

        }
    }

    function confirmAndResetDiet() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–∞—Ü–∏–æ–Ω? –û–Ω –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω, –∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.")) {

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–æ—á–∫–∏
            const dietCard = document.getElementById('diet-card-container');
            const loader = document.createElement('div');
            loader.className = 'absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center rounded-xl z-20';
            loader.innerHTML = '<svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>';
            dietCard.appendChild(loader);

            fetch('/reset_diet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // –ü—Ä—è—á–µ–º –±–ª–æ–∫ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –¥–∏–µ—Ç—ã
                    document.getElementById('diet-display-section').style.display = 'none';
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å —Ñ–æ—Ä–º–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    document.getElementById('diet-generation-section').style.display = 'block';
                } else {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(err => {
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å —Ä–∞—Ü–∏–æ–Ω.');
            })
            .finally(() => {
                // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                dietCard.removeChild(loader);
            });
        }
    }
</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–∏–Ω–∞–º–∏–∫–∏ ---
    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –∏ –µ—Å—Ç—å –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
        // (–≤ —à–∞–±–ª–æ–Ω–µ —ç–ª–µ–º–µ–Ω—Ç canvas –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏)
        const weightChartCanvas = document.getElementById('weightChart');
        if (weightChartCanvas) {
            fetch('/api/user/weekly_summary')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    renderCharts(data);
                })
                .catch(err => console.error("Failed to load chart data:", err));
        }
    });

    function renderCharts(data) {
        const { labels, datasets } = data;

       const commonOptions = {
  responsive: true,
  maintainAspectRatio: false,
  animation: false,
  devicePixelRatio: 2,
  plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
  scales: { x: { grid: { display: false } }, y: { beginAtZero: false, ticks: { maxTicksLimit: 5 } } },
  elements: { point: { radius: 2 }, line: { borderWidth: 2, tension: 0.4 } }
};


        // –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞
        new Chart(document.getElementById('weightChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '–í–µ—Å',
                    data: datasets.weight,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                }]
            },
            options: commonOptions
        });

        // –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–Ω—ã—Ö –∫–∞–ª–æ—Ä–∏–π
        new Chart(document.getElementById('mealsChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ',
                    data: datasets.consumed_kcal,
                    borderColor: 'rgb(249, 115, 22)',
                    backgroundColor: 'rgba(249, 115, 22, 0.5)',
                }]
            },
            options: commonOptions
        });

        // –ì—Ä–∞—Ñ–∏–∫ —Å–æ–∂–∂–µ–Ω–Ω—ã—Ö –∫–∞–ª–æ—Ä–∏–π
        new Chart(document.getElementById('activityChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '–°–æ–∂–∂–µ–Ω–æ',
                    data: datasets.burned_kcal,
                    borderColor: 'rgb(22, 163, 74)',
                    backgroundColor: 'rgba(22, 163, 74, 0.5)',
                }]
            },
            options: commonOptions
        });
    }

    // --- (–∑–¥–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –≤–∞—à JS –∫–æ–¥: confirmAndResetDiet –∏ —Ç.–¥.) ---
</script>

<div id="deficitHistoryModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="closeDeficitHistoryModal()">
  <div class="card w-full max-w-2xl p-0 relative animate-fade-in" onclick="event.stopPropagation()">

    <div class="p-5 border-b border-slate-200 flex justify-between items-center">
        <h2 class="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–µ—Ñ–∏—Ü–∏—Ç–∞</h2>
        <button onclick="closeDeficitHistoryModal()" class="text-slate-400 text-2xl hover:text-slate-600">&times;</button>
    </div>

    <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div id="deficit-loader" class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
            <p class="mt-2 text-slate-500">–ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é...</p>
        </div>

        <div id="deficit-content" class="hidden">
            </div>
    </div>
  </div>
</div>
<script>
    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ ---
const deficitModal = document.getElementById('deficitHistoryModal');
const deficitLoader = document.getElementById('deficit-loader');
const deficitContent = document.getElementById('deficit-content');

function showDeficitHistory() {
    if (!deficitModal) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –∑–∞–≥—Ä—É–∑—á–∏–∫
    deficitModal.classList.remove('hidden');
    deficitModal.classList.add('flex');
    deficitLoader.classList.remove('hidden');
    deficitContent.classList.add('hidden');
    deficitContent.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

    fetch('/api/user/deficit_history')
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                deficitContent.innerHTML = `<p class="text-center text-red-500">${data.error}</p>`;
            } else {
                let tableHtml = `
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-600">
                            <tr>
                                <th class="p-2">–î–∞—Ç–∞</th>
                                <th class="p-2 text-right text-red-600">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–æ</th>
                                <th class="p-2 text-right text-green-600">–°–æ–∂–∂–µ–Ω–æ (–ë–∞–∑–∞ + –ê–∫—Ç)</th>
                                <th class="p-2 text-right text-blue-600">–î–µ—Ñ–∏—Ü–∏—Ç –∑–∞ –¥–µ–Ω—å</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let totalDeficit = 0;
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ)
                data.reverse().forEach(day => {
                    totalDeficit += day.deficit;
                    tableHtml += `
                        <tr class="border-b">
                            <td class="p-2 font-medium">${day.date}</td>
                            <td class="p-2 text-right">${day.consumed} –∫–∫–∞–ª</td>
                            <td class="p-2 text-right">${day.total_burned} –∫–∫–∞–ª</td>
                            <td class="p-2 text-right font-bold">${day.deficit} –∫–∫–∞–ª</td>
                        </tr>
                    `;
                });

                tableHtml += `
                        </tbody>
                        <tfoot>
                            <tr class="bg-slate-100 font-bold">
                                <td class="p-2" colspan="3">–ò—Ç–æ–≥–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞:</td>
                                <td class="p-2 text-right text-blue-700 text-base">${Math.round(totalDeficit)} –∫–∫–∞–ª</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
                deficitContent.innerHTML = tableHtml;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
            deficitLoader.classList.add('hidden');
            deficitContent.classList.remove('hidden');
        })
        .catch(err => {
            deficitContent.innerHTML = `<p class="text-center text-red-500">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –û—à–∏–±–∫–∞: ${err}</p>`;
            deficitLoader.classList.add('hidden');
            deficitContent.classList.remove('hidden');
        });
}

function closeDeficitHistoryModal() {
    if (deficitModal) {
        deficitModal.classList.add('hidden');
        deficitModal.classList.remove('flex');
    }
}

    function lockScroll(lock = true) {
  document.documentElement.style.overflow = lock ? 'hidden' : '';
}

function trapFocus(modalEl) {
  const focusables = modalEl.querySelectorAll(
    'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
  );
  if (!focusables.length) return;
  const first = focusables[0], last = focusables[focusables.length - 1];
  modalEl.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') return;
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault(); last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault(); first.focus();
    }
  });
  (first || modalEl).focus();
}

function openModal(id) {
  const m = document.getElementById(id);
  if (!m) return;
  m.classList.remove('hidden'); m.classList.add('flex');
  lockScroll(true);
  setTimeout(() => trapFocus(m), 0);
}

function closeModal(id) {
  const m = document.getElementById(id);
  if (!m) return;
  m.classList.add('hidden'); m.classList.remove('flex');
  lockScroll(false);
}

</script>
{% endblock %}