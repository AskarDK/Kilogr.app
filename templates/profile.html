{% extends 'base.html' %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
   <div class="flex border-b mb-6">
    <a href="/profile"
       class="px-4 py-2 font-medium {% if request.path == '/profile' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
      –ü—Ä–æ—Ñ–∏–ª—å
    </a>
    <a href="/metrics"
       class="px-4 py-2 font-medium {% if request.path == '/metrics' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
      –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    </a>
    <a href="/activity"
       class="px-4 py-2 font-medium {% if request.path == '/activity' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
      –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    </a>
  </div>

  {% if request.path == '/profile' %}
  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è -->
  <div class="space-y-6">

    <!-- Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è -->
    {% if user.telegram_chat_id %}
    <div class="flex justify-between items-center bg-green-50 border border-green-200 p-5 rounded-xl shadow-sm">
      <div class="text-green-800 text-sm">
        ‚úÖ <strong>Telegram:</strong> –ü—Ä–∏–≤—è–∑–∞–Ω
      </div>
      <button onclick="openTelegramModal()" class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
        üîÑ –°–º–µ–Ω–∏—Ç—å
      </button>
    </div>
    {% else %}
    <div class="flex justify-between items-center bg-blue-50 border border-blue-200 p-5 rounded-xl shadow-sm">
      <div class="text-blue-800 text-sm">
        üì≤ <strong>Telegram:</strong> –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω
      </div>
      <button onclick="openTelegramModal()" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm">
        üîë –ü—Ä–∏–≤—è–∑–∞—Ç—å
      </button>
    </div>
    {% endif %}

    <div class="grid md:grid-cols-2 gap-6 items-start">

      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–ø—Ä–æ—Ñ–∏–ª—å + –∑–∞–≥—Ä—É–∑–∫–∞) -->
      <div class="space-y-6">
        <div class="text-center bg-white p-6 rounded-xl shadow">
          <img src="https://www.svgrepo.com/show/452070/user-avatar.svg"
               alt="Avatar"
               class="w-28 h-28 mx-auto rounded-full border-4 border-blue-500 shadow-md mb-4">
          <h2 class="text-lg font-semibold">{{ user.name }}</h2>
          <p class="text-sm text-gray-500">{{ user.email }}</p>
        </div>

<!-- –ê–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞: —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI -->
<div class="bg-white rounded-xl shadow p-4 transition-all duration-300 group" id="analysisCard">
  {% if user.height and user.weight %}
    <button onclick="toggleAnalysisForm()" type="button"
            class="w-full flex items-center justify-between p-4 rounded-lg border border-blue-100 bg-blue-50 hover:bg-blue-100 text-sm font-medium text-blue-700 transition">
      <div class="flex items-center gap-3">
        <span class="text-xl">üì•</span>
        <span>–°–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–º–µ—Ä</span>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform duration-300 group-hover:rotate-180"
           fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 9l-7 7-7-7"/>
      </svg>
    </button>

    <form id="uploadForm" action="/upload_analysis" method="POST" enctype="multipart/form-data"
          class="hidden mt-4 border-t pt-4 space-y-4 animate-fade-in">
      <div>
        <label class="block text-sm text-gray-600 mb-1">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ PDF –∞–Ω–∞–ª–∏–∑–∞</label>
        <input type="file" name="file" accept=".pdf,.png,.jpg,.jpeg" required
               class="w-full p-2 text-sm border rounded focus:ring focus:ring-blue-200">
      </div>
      <button type="submit"
              class="w-full py-2 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 transition">
        üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
      </button>
      <div id="loading" class="text-center text-xs text-gray-400 hidden">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ AI...</div>
    </form>

  {% else %}
    <form action="/upload_analysis" method="POST" enctype="multipart/form-data" class="space-y-4">
      <label class="block text-sm text-gray-600 mb-1">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞</label>
      <input type="file" name="file" accept=".pdf,.png,.jpg,.jpeg" required
             class="w-full p-2 text-sm border rounded focus:ring focus:ring-blue-200">
      <button type="submit"
              class="w-full py-2 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 transition">
        –ó–∞–≥—Ä—É–∑–∏—Ç—å
      </button>
      <div id="loading" class="text-center text-xs text-gray-400 hidden">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ AI...</div>
    </form>
  {% endif %}
</div>


      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–¥–∞–Ω–Ω—ã–µ —Ç–µ–ª–∞ + –¥–∏–µ—Ç–∞) -->
      <div class="space-y-6">

        <!-- –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ç–µ–ª–∞ -->
        <div class="bg-white p-6 rounded-xl shadow space-y-6">
          <h3 class="text-xl font-semibold text-gray-800">üìä –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ç–µ–ª–∞</h3>
         {# 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∏ —Ñ–ª–∞–≥: True –µ—Å–ª–∏ —Ä–æ—Å—Ç –≤–≤–µ—Ä—Ö ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–æ #}
{% set metrics = [
  ('–†–æ—Å—Ç',        'height',              'üìè', '—Å–º',  True),
  ('–í–µ—Å',         'weight',              '‚öñÔ∏è', '–∫–≥',  False),
  ('–ú—ã—à—Ü—ã',       'muscle_mass',         'üí™', '–∫–≥',  True),
  ('–ñ–∏—Ä',         'fat_mass',            'üßà', '–∫–≥',  False),
  ('–í–æ–¥–∞',        'body_water',          'üíß', '%',  True),
  ('–ú–µ—Ç–∞–±–æ–ª–∏–∑–º',  'metabolism',          '‚ö°', '–∫–∫–∞–ª',True),
  ('–ë–µ–ª–æ–∫',       'protein_percentage',  'ü•ö', '%',  True),
  ('–í–∏—Å—Ü. –∂–∏—Ä',   'visceral_fat_rating', 'üî•', '',   False),
  ('–ò–ú–¢',         'bmi',                 'üìê', '',   False)
] %}

<div class="grid grid-cols-2 md:grid-cols-3 gap-4">
  {% for label, field, icon, unit, good_up in metrics %}{% set cur = latest_analysis[field] if latest_analysis else none %}
{% set prev = previous_analysis[field] if previous_analysis else none %}
{% if cur is not none and prev is not none %}
  {% set cur = cur|float %}
  {% set prev = prev|float %}
  {% set diff = cur - prev %}
  {% set pct = (diff / prev * 100) if prev != 0 else none %}
  {% if diff > 0 %}
    {% set arrow = '‚Üë' %}
    {% set is_good = good_up %}
  {% else %}
    {% set arrow = '‚Üì' %}
    {% set is_good = not good_up %}
  {% endif %}
{% else %}
  {% set diff = none %}
{% endif %}


    <div class="bg-gray-50 p-4 rounded-lg shadow flex flex-col justify-between text-center">
      <div class="text-sm text-gray-500 mb-1 flex items-center justify-center gap-1">
        <span>{{ icon }}</span> {{ label }}
      </div>
      <div class="text-lg font-semibold text-gray-800 mt-auto">
        {{ cur or 'n/a' }}{% if cur and unit %}<span class="text-sm text-gray-500">{{ unit }}</span>{% endif %}
      </div>

      {% if diff is not none %}
        <div>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium
                       {% if is_good %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
            {{ arrow }} {{ diff|abs|round(1) }}{{ unit }}
            {% if pct is not none %} ({{ pct|abs|round(1) }}%){% endif %}
          </span>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>


          {% if user.analysis_comment %}
          <div class="bg-blue-50 border border-blue-200 p-4 rounded text-sm text-blue-800">
            üí¨ <strong>AI-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {{ user.analysis_comment }}
          </div>
          {% endif %}
        </div>

        <!-- –î–∏–µ—Ç–∞ -->
        <div class="bg-white p-6 rounded-xl shadow space-y-6">
          <h3 class="text-xl font-semibold text-gray-800">üìà –í–∞—à —Ä–∞—Ü–∏–æ–Ω</h3>

          {% if diet %}
            <a href="/diet" class="block transform hover:scale-[1.01] transition duration-200">
  <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 p-6 rounded-2xl shadow-lg space-y-4">
    <div class="flex justify-between items-center">
      <div class="text-sm text-blue-800 font-medium">
        üóìÔ∏è –†–∞—Ü–∏–æ–Ω –∑–∞ {{ diet.date.strftime('%d.%m.%Y') }}
      </div>
      <div class="text-xs text-gray-500 italic">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π</div>
    </div>

    {% for meal_name, meal_items in {
      'üç≥ –ó–∞–≤—Ç—Ä–∞–∫': breakfast,
      'üç≤ –û–±–µ–¥': lunch,
      'üçù –£–∂–∏–Ω': dinner,
      'üçé –ü–µ—Ä–µ–∫—É—Å': snack
    }.items() %}
    <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm">
      <div class="text-sm font-semibold text-gray-700 mb-2">{{ meal_name }}</div>
      <ul class="space-y-1 text-sm text-gray-600">
        {% for itm in meal_items %}
        <li class="flex justify-between">
          <span>{{ itm.name }}</span>
          <span class="text-right text-xs text-gray-500">
            {{ itm.grams }} –≥, {{ itm.kcal }} –∫–∫–∞–ª
          </span>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}

    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-center text-gray-700 mt-2">
      <div class="bg-green-50 py-2 rounded-lg">
        <div class="text-xs text-green-800">–ö–∞–ª–æ—Ä–∏–∏</div>
        <div class="font-bold text-green-700">{{ diet.total_kcal }} –∫–∫–∞–ª</div>
      </div>
      <div class="bg-blue-50 py-2 rounded-lg">
        <div class="text-xs text-blue-800">–ë–µ–ª–∫–∏</div>
        <div class="font-bold text-blue-700">{{ diet.protein }} –≥</div>
      </div>
      <div class="bg-yellow-50 py-2 rounded-lg">
        <div class="text-xs text-yellow-800">–ñ–∏—Ä—ã</div>
        <div class="font-bold text-yellow-700">{{ diet.fat }} –≥</div>
      </div>
      <div class="bg-purple-50 py-2 rounded-lg">
        <div class="text-xs text-purple-800">–£–≥–ª–µ–≤–æ–¥—ã</div>
        <div class="font-bold text-purple-700">{{ diet.carbs }} –≥</div>
      </div>
    </div>
  </div>
</a>

            <form action="/reset_diet" method="POST" class="text-right">
              <button type="submit" class="text-sm text-red-600 underline hover:text-red-800">–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏–µ—Ç—É</button>
            </form>
          {% elif user.height and user.weight and user.muscle_mass %}
            <form id="dietForm" class="space-y-6">
              <div>
                <label class="block text-sm font-medium mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</label>
                <textarea name="preferences" rows="2"
                          class="w-full border rounded p-2 focus:ring focus:ring-blue-200"></textarea>
              </div>

              <!-- –¶–µ–ª—å -->
              <div>
                <label class="block text-sm font-medium mb-2">–¶–µ–ª—å</label>
                <div class="flex gap-4">
                  {% for g in [
                    {'label': '–ù–∞–±–æ—Ä', 'icon': 'üí™', 'value': 'muscle'},
                    {'label': '–ü–æ—Ö—É–¥–µ–Ω–∏–µ', 'icon': 'üî•', 'value': 'loss'},
                    {'label': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ', 'icon': '‚öñÔ∏è', 'value': 'maintain'}
                  ] %}
                  <div class="goal-card flex flex-col items-center p-4 rounded-lg border cursor-pointer hover:shadow"
                       data-value="{{ g.value }}">
                    <div class="text-2xl">{{ g.icon }}</div>
                    <div class="text-sm mt-1">{{ g.label }}</div>
                  </div>
                  {% endfor %}
                </div>
                <input type="hidden" name="goal" id="goalInput">
              </div>

              <!-- –ü–æ–ª -->
              <div>
                <label class="block text-sm font-medium mb-2">–ü–æ–ª</label>
                <div class="flex gap-4">
                  {% for g in [
                    {'label': '–ú—É–∂—Å–∫–æ–π', 'icon': '‚ôÇÔ∏è', 'value': 'male'},
                    {'label': '–ñ–µ–Ω—Å–∫–∏–π', 'icon': '‚ôÄÔ∏è', 'value': 'female'}
                  ] %}
                  <div class="gender-card flex items-center justify-center p-4 rounded-lg border cursor-pointer hover:shadow"
                       data-value="{{ g.value }}">
                    <div class="text-xl mr-2">{{ g.icon }}</div>
                    <div class="text-sm">{{ g.label }}</div>
                  </div>
                  {% endfor %}
                </div>
                <input type="hidden" name="gender" id="genderInput">
              </div>

              <button type="button" onclick="startDietGeneration()"
                      class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏–µ—Ç—É
              </button>
            </form>
          {% else %}
            <p class="text-sm text-gray-500">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–µ—Ç—ã.</p>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

   {% elif request.path == '/metrics' %}
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–∞ ¬´–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏¬ª -->
    <div class="space-y-6">

      <!-- 1) –î–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4">üìà –î–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>

        {% if missing_meals or missing_activity %}
          <p class="text-gray-600">–ß—Ç–æ–±—ã –ø–æ—Å—á–∏—Ç–∞—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç, –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ:</p>
          <ul class="list-disc list-inside text-sm text-gray-700">
            {% if missing_meals %}
              <li>–ü—Ä–∏—ë–º—ã –ø–∏—â–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</li>
            {% endif %}
            {% if missing_activity %}
              <li>–î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</li>
            {% endif %}
          </ul>
          <p class="mt-2 text-sm text-red-600">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö.</p>
        {% else %}
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div class="bg-green-50 p-4 rounded-lg">
              <div class="text-sm text-green-800">–ú–µ—Ç–∞–±–æ–ª–∏–∑–º</div>
              <div class="text-lg font-bold">{{ metabolism }} –∫–∫–∞–ª</div>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
              <div class="text-sm text-blue-800">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∫–∞–ª</div>
              <div class="text-lg font-bold">{{ active_kcal }} –∫–∫–∞–ª</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
              <div class="text-sm text-yellow-800">–°—ä–µ–¥–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
              <div class="text-lg font-bold">{{ total_meals }} –∫–∫–∞–ª</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg">
              <div class="text-sm text-red-800">–î–µ—Ñ–∏—Ü–∏—Ç</div>
              <div class="text-lg font-bold">{{ deficit }} –∫–∫–∞–ª</div>
            </div>
          </div>
        {% endif %}
      </div>

      <!-- 2) –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-semibold mb-3">üîπ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">–®–∞–≥–∏</div>
            <div class="text-xl font-bold">{{ steps or '‚Äî' }}</div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">–î–∏—Å—Ç–∞–Ω—Ü–∏—è</div>
            <div class="text-xl font-bold">{{ distance_km or '‚Äî' }} –∫–º</div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∫–∞–ª</div>
            <div class="text-xl font-bold">{{ active_kcal or '‚Äî' }}</div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">–ü–æ–∫–æ–π –∫–∫–∞–ª</div>
            <div class="text-xl font-bold">{{ resting_kcal or '‚Äî' }}</div>
          </div>
        </div>
      </div>

      <!-- 3) –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –ø—Ä–∏—ë–º–∞–º –ø–∏—â–∏ -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-semibold mb-3">üçΩÔ∏è –ü—Ä–∏—ë–º—ã –ø–∏—â–∏</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          {% for meal in today_meals %}
            <div class="bg-gray-50 p-4 rounded-lg text-center">
              <div class="text-sm text-gray-500">{{ meal.meal_type|capitalize }}</div>
              <div class="mt-2 text-lg font-bold">{{ meal.calories }} –∫–∫–∞–ª</div>
            </div>
          {% else %}
            <div class="col-span-4 text-sm text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏—ë–º–∞—Ö –ø–∏—â–∏</div>
          {% endfor %}
        </div>
      </div>

    </div>
  {% elif request.path == '/activity' %}
  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
  <div class="space-y-6">
    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-xl font-semibold mb-4">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>

      {% if today_activity %}
      <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium">–°–µ–≥–æ–¥–Ω—è</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="text-sm text-gray-500">–®–∞–≥–∏</div>
              <div class="text-xl font-bold">{{ today_activity.steps or '‚Äî' }}</div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="text-sm text-gray-500">–î–∏—Å—Ç–∞–Ω—Ü–∏—è</div>
              <div class="text-xl font-bold">{{ today_activity.distance_km or '‚Äî' }} –∫–º</div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="text-sm text-gray-500">–ö–∞–ª–æ—Ä–∏–∏</div>
              <div class="text-xl font-bold">{{ today_activity.active_kcal or '‚Äî' }}</div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="text-sm text-gray-500">–ü—É–ª—å—Å</div>
              <div class="text-xl font-bold">{{ today_activity.heart_rate_avg or '‚Äî' }} —É–¥/–º–∏–Ω</div>
            </div>
          </div>
        </div>

        <!-- –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö -->
        <div>
          <h3 class="text-lg font-medium mb-4">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö</h3>
          <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
            <div class="flex items-center">
              <div class="bg-blue-100 p-3 rounded-full mr-4">
                <span class="text-blue-600">üì±</span>
              </div>
              <div>
                <div class="font-medium">{{ today_activity.source or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                <div class="text-sm text-gray-500">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {{ today_activity.date.strftime('%H:%M') }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
      <div class="space-y-8">
        <div>
          <h3 class="text-lg font-medium mb-3">–®–∞–≥–∏ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
          <div class="h-64 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">
            [–ì—Ä–∞—Ñ–∏–∫ —à–∞–≥–æ–≤]
          </div>
        </div>

        <div>
          <h3 class="text-lg font-medium mb-3">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</h3>
          <div class="h-64 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">
            [–ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏]
          </div>
        </div>
      </div>
      {% else %}
      <div class="text-center py-10">
        <div class="text-gray-400 mb-4">üìä</div>
        <p class="text-gray-500">–î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        <p class="text-sm text-gray-400 mt-2">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (Apple Health, Google Fit –∏ —Ç.–¥.)</p>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

</div>

<!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –∏ –º–æ–¥–∞–ª–∫–∏ (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<div id="dietLoader" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50 hidden">
  <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none"
       viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8v8z"></path>
  </svg>
  <p class="mt-2 text-gray-700">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∏–µ—Ç—É –ø–æ —Ç–≤–æ–∏–º –¥–∞–Ω–Ω—ã–º...</p>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ Telegram -->
<div id="telegramModal" class="fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white p-6 rounded-lg w-full max-w-md shadow-xl relative space-y-4 text-center animate-fade-in">
    <button onclick="closeTelegramModal()" class="absolute top-2 right-4 text-gray-400 text-2xl hover:text-gray-600">&times;</button>
    <h2 class="text-xl font-semibold">üîê –ü—Ä–∏–≤—è–∑–∫–∞ Telegram</h2>
    <p class="text-gray-600 text-sm">
      –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ <a href="https://t.me/DietFor35MinuteBot" target="_blank" class="text-blue-600 underline">Telegram-–±–æ—Ç–∞</a>, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å:
    </p>
    <div class="bg-gray-100 rounded-lg px-4 py-3 text-lg font-mono tracking-wider inline-block" id="tgCodeDisplay">...</div>
    <button onclick="copyCode()" class="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
      üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
    </button>
  </div>
</div>

<style>
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: scale(0.9);}
    to {opacity: 1; transform: scale(1);}
  }
</style>

<script>
  // –¶–µ–ª—å
  document.querySelectorAll('.goal-card').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('ring-4', 'ring-offset-2', 'ring-green-500'))
      el.classList.add('ring-4', 'ring-offset-2', 'ring-green-500', 'shadow-lg');
      document.getElementById('goalInput').value = el.dataset.value;
    });
  });

  // –ü–æ–ª
  document.querySelectorAll('.gender-card').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.gender-card').forEach(c => c.classList.remove('ring-4', 'ring-offset-2', 'ring-blue-500'))
      el.classList.add('ring-4', 'ring-offset-2', 'ring-blue-500', 'shadow-lg');
      document.getElementById('genderInput').value = el.dataset.value;
    });
  });

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–µ—Ç—ã
  function startDietGeneration() {
    const goal = document.getElementById('goalInput').value;
    const gender = document.getElementById('genderInput').value;
    const preferences = document.querySelector('textarea[name="preferences"]').value;
    if (!goal || !gender) return alert('–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å –∏ –ø–æ–ª.');

    const loader = document.getElementById('dietLoader');
    loader.classList.remove('hidden');

    const params = new URLSearchParams({ goal, gender, preferences });
    fetch('/generate_diet?' + params)
      .then(res => res.json())
      .then(data => {
        loader.classList.add('hidden');
        if (data.redirect) window.location = data.redirect;
        else alert('–û—à–∏–±–∫–∞: ' + JSON.stringify(data));
      })
      .catch(err => {
        loader.classList.add('hidden');
        alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + err.message);
      });
  }

  // Telegram
  function openTelegramModal() {
    fetch('/generate_telegram_code')
      .then(res => res.json())
      .then(data => {
        document.getElementById('tgCodeDisplay').textContent = data.code;
        document.getElementById('telegramModal').classList.remove('hidden');
        document.getElementById('telegramModal').classList.add('flex');
      })
      .catch(err => alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞: ' + err.message));
  }

  function closeTelegramModal() {
    document.getElementById('telegramModal').classList.add('hidden');
    document.getElementById('telegramModal').classList.remove('flex');
  }

  function copyCode() {
    const code = document.getElementById('tgCodeDisplay').textContent;
    navigator.clipboard.writeText(code).then(() => {
      alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
    });
  }
</script>

<script>
  function toggleAnalysisForm() {
    const form = document.getElementById("uploadForm");
    if (form.classList.contains("hidden")) {
      form.classList.remove("hidden");
    } else {
      form.classList.add("hidden");
    }
  }
</script>

{% endblock %}
