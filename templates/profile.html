{% extends 'base.html' %}
{% block content %}

<div class="max-w-5xl mx-auto px-4 py-10 space-y-8">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + Telegram -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div class="space-y-2">
      <h1 class="text-3xl font-bold text-gray-800">üë§ –ü—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h1>

      <!-- Telegram –±–ª–æ–∫ -->
      <div class="relative group">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 pr-24 shadow-sm transition group-hover:shadow-lg">
          <p class="text-sm text-blue-800">
            üì≤ <strong>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram-–±–æ—Ç</strong> –∫ –≤–∞—à–µ–º—É –ø—Ä–æ—Ñ–∏–ª—é,<br>
            —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –∞–Ω–∞–ª–∏–∑–∞ –∏ –¥–∏–µ—Ç—ã –ø—Ä—è–º–æ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.
          </p>
        </div>
        <a href="https://t.me/@DietFor35MinuteBot" target="_blank"
           class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-2 px-4 py-2 bg-[#229ED9] text-white rounded-md text-base font-medium hover:bg-[#1d90c8] transition shadow">
          <i class="bi bi-telegram text-xl"></i>
          –ë–æ—Ç
        </a>
      </div>
    </div>

    <a href="/logout" class="text-red-600 hover:text-red-800 transition">–í—ã–π—Ç–∏</a>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="flex flex-col items-center md:items-start space-y-4">
      <img src="https://www.svgrepo.com/show/452070/user-avatar.svg"
           alt="Avatar"
           class="w-28 h-28 rounded-full border-4 border-blue-500 shadow-md">
      <h2 class="text-lg font-semibold">{{ user.name }}</h2>
      <p class="text-sm text-gray-500">{{ user.email }}</p>

      <!-- –ê–Ω–∞–ª–∏–∑ —Ç–∞—Ä–≥–µ—Ç -->
      <form action="/upload_analysis" method="POST" enctype="multipart/form-data"
            class="w-full space-y-2">
        <label class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞</label>
        <input type="file" name="file" accept=".pdf,.png,.jpg,.jpeg" required
               class="w-full text-sm p-2 border rounded focus:ring focus:ring-blue-200">
        <button type="submit"
                class="w-full py-2 bg-blue-600 text-white font-medium rounded shadow hover:bg-blue-700 transition">
          –ó–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
        <div id="loading" class="hidden text-xs text-gray-400 text-center">
          –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ AI...
        </div>
      </form>
    </div>

    <!-- –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ç–µ–ª–∞ –∏ —Ä–∞—Ü–∏–æ–Ω -->
    <div class="md:col-span-2 space-y-8">

      <!-- –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
      <div class="bg-gray-50 p-6 rounded-xl shadow">
        <h3 class="text-xl font-semibold mb-4">üìä –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ç–µ–ª–∞</h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          {% for label, value in {
            '–†–æ—Å—Ç': user.height,
            '–í–µ—Å': user.weight,
            '–ú—ã—à—Ü—ã': user.muscle_mass,
            '–ñ–∏—Ä': user.fat_mass,
            '–ú–µ—Ç–∞–±–æ–ª–∏–∑–º': user.metabolism,
            '–ò–ú–¢': user.bmi
          }.items() %}
          <div class="flex flex-col items-center bg-white p-4 rounded-lg shadow hover:shadow-lg transition">
            <span class="text-gray-400 text-sm">{{ label }}</span>
            <span class="text-lg font-semibold">{{ value or 'n/a' }}</span>
          </div>
          {% endfor %}
        </div>

        {% if user.analysis_comment %}
        <div class="mt-6 bg-blue-100 border border-blue-300 p-4 rounded text-sm text-blue-800">
          üí¨ <strong>AI-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {{ user.analysis_comment }}
        </div>
        {% endif %}
      </div>

      <!-- –†–∞—Ü–∏–æ–Ω -->
      <div class="bg-gray-50 p-6 rounded-xl shadow">
        <h3 class="text-xl font-semibold mb-4">üìà –í–∞—à —Ä–∞—Ü–∏–æ–Ω</h3>

        {% if diet %}
          <a href="/diet" class="block transform transition duration-300 hover:scale-[1.015] hover:shadow-xl active:scale-95">
            <div class="bg-white rounded-xl shadow p-4">
              <div class="mb-2 text-sm text-gray-500">–†–∞—Ü–∏–æ–Ω –∑–∞ {{ diet.date.strftime('%d.%m.%Y') }}</div>
              <ul class="list-disc list-inside text-gray-800 text-sm space-y-2">
                {% for meal_name, meal_items in {
                  '–ó–∞–≤—Ç—Ä–∞–∫': breakfast,
                  '–û–±–µ–¥': lunch,
                  '–£–∂–∏–Ω': dinner,
                  '–ü–µ—Ä–µ–∫—É—Å': snack
                }.items() %}
                <li><strong>{{ meal_name }}:</strong><br>
                  {% for itm in meal_items %}
                    {{ itm.name }} ‚Äî <span class="text-green-600">{{ itm.grams }} –≥</span>,
                    <span class="text-blue-600">{{ itm.kcal }} –∫–∫–∞–ª</span><br>
                  {% endfor %}
                </li>
                {% endfor %}
              </ul>
              <div class="mt-4 text-right text-xs italic text-gray-400">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ</div>
            </div>
          </a>
          <form action="/reset_diet" method="POST" class="text-right mt-4">
            <button type="submit"
                    class="text-red-600 hover:text-red-800 transition underline text-sm">
              –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏–µ—Ç—É
            </button>
          </form>
        {% elif user.height and user.weight and user.muscle_mass %}
          <form id="dietForm" class="space-y-6">

            <div>
              <label class="block text-sm font-medium mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</label>
              <textarea name="preferences" rows="2"
                        class="w-full border rounded p-2 focus:ring focus:ring-blue-200"></textarea>
            </div>

            <!-- –¶–µ–ª—å -->
            <div>
              <label class="block text-sm font-medium mb-2">–¶–µ–ª—å</label>
              <div class="flex gap-4">
                {% set goals = [
                  {'label': '–ù–∞–±–æ—Ä', 'icon': 'üí™', 'value': 'muscle', 'color': 'green'},
                  {'label': '–ü–æ—Ö—É–¥–µ–Ω–∏–µ', 'icon': 'üî•', 'value': 'loss', 'color': 'red'},
                  {'label': '–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ', 'icon': '‚öñÔ∏è', 'value': 'maintain', 'color': 'blue'}
                ] %}
                {% for g in goals %}
                  <div class="goal-card flex flex-col items-center p-4 rounded-lg border transition cursor-pointer
                              hover:shadow-lg peer"
                       data-value="{{ g.value }}">
                    <div class="text-3xl">{{ g.icon }}</div>
                    <div class="mt-2 text-sm">{{ g.label }}</div>
                  </div>
                {% endfor %}
              </div>
              <input type="hidden" name="goal" id="goalInput">
            </div>

            <!-- –ü–æ–ª -->
            <div>
              <label class="block text-sm font-medium mb-2">–ü–æ–ª</label>
              <div class="flex gap-4">
                {% set genders = [
                  {'label': '–ú—É–∂—Å–∫–æ–π', 'icon': '‚ôÇÔ∏è', 'value': 'male', 'color': 'blue'},
                  {'label': '–ñ–µ–Ω—Å–∫–∏–π', 'icon': '‚ôÄÔ∏è', 'value': 'female', 'color': 'pink'}
                ] %}
                {% for g in genders %}
                  <div class="gender-card flex items-center justify-center p-4 rounded-lg border transition cursor-pointer peer"
                       data-value="{{ g.value }}">
                    <div class="text-xl mr-2">{{ g.icon }}</div>
                    <div class="text-sm">{{ g.label }}</div>
                  </div>
                {% endfor %}
              </div>
              <input type="hidden" name="gender" id="genderInput">
            </div>

            <button type="button"
                    onclick="startDietGeneration()"
                    class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
              –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏–µ—Ç—É
            </button>
          </form>
        {% else %}
          <p class="text-sm text-gray-500">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–µ—Ç—ã.</p>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä -->
<div id="dietLoader" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50 hidden">
  <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none"
       viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8v8z"></path>
  </svg>
  <p class="mt-2 text-gray-700">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∏–µ—Ç—É –ø–æ —Ç–≤–æ–∏–º –¥–∞–Ω–Ω—ã–º...</p>
</div>

<script>
  // –í—ã–±–æ—Ä —Ü–µ–ª–∏
  document.querySelectorAll('.goal-card').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('ring-4', 'ring-offset-2', 'ring-green-500'))
      el.classList.add('ring-4', 'ring-offset-2', 'ring-green-500', 'shadow-lg');
      document.getElementById('goalInput').value = el.dataset.value;
    });
  });

  // –í—ã–±–æ—Ä –ø–æ–ª–∞
  document.querySelectorAll('.gender-card').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.gender-card').forEach(c => c.classList.remove('ring-4', 'ring-offset-2', 'ring-blue-500'))
      el.classList.add('ring-4', 'ring-offset-2', 'ring-blue-500', 'shadow-lg');
      document.getElementById('genderInput').value = el.dataset.value;
    });
  });

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
  function startDietGeneration() {
    const goal = document.getElementById('goalInput').value;
    const gender = document.getElementById('genderInput').value;
    const preferences = document.querySelector('textarea[name="preferences"]').value;
    if (!goal || !gender) return alert('–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å –∏ –ø–æ–ª.');

    const loader = document.getElementById('dietLoader');
    loader.classList.remove('hidden');

    const params = new URLSearchParams({ goal, gender, preferences });
    fetch('/generate_diet?' + params)
      .then(res => res.json())
      .then(data => {
        loader.classList.add('hidden');
        if (data.redirect) window.location = data.redirect;
        else alert('–û—à–∏–±–∫–∞: ' + JSON.stringify(data));
      })
      .catch(err => {
        loader.classList.add('hidden');
        alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + err.message);
      });
  }
</script>

{% endblock %}